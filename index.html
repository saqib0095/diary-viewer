<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' /> 
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script> 

<div id='calendar-container' style="font-family: sans-serif; background: white; padding: 15px; border-radius: 8px;"> 
  <div id='status' style="text-align:center; color: #666; margin-bottom: 10px;">Checking Timetastic...</div> 
  <div id='calendar'></div> 
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const statusEl = document.getElementById('status');

  const cache = {}; // store fetched months
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  const fetchMonthEvents = async (year, month) => {
    const monthKey = `${year}-${String(month+1).padStart(2,'0')}`;
    if (cache[monthKey]) return cache[monthKey];

    statusEl.innerHTML = `Fetching ${monthKey}...`;

    const format = d => {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    };

    const monthStart = new Date(year, month, 1);
    const monthEnd = new Date(year, month + 1, 0);
    const startStr = format(monthStart) + "T00:00:00";
    const endStr = format(monthEnd) + "T23:59:59";

    try {
      const url = `https://timetastic-proxy.onrender.com/diary?from=${startStr}&to=${endStr}`;
      const response = await fetch(url);
      if (!response.ok) throw new Error("Fetch failed: " + response.status);
      const data = await response.json();

      const events = [];
      data.forEach(day => {
        if (!day.absences) return;
        day.absences.forEach(abs => {
          if (abs.absenceType === "PublicHoliday") return;
          events.push({ title: abs.userName, start: day.date, allDay: true });
        });
      });

      cache[monthKey] = events;
      statusEl.innerHTML = "";
      return events;

    } catch(e) {
      console.error(e);
      statusEl.innerHTML = "Connection error";
      return [];
    }
  };

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: "auto",
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,listMonth'
    },

    events: function(info, successCallback) {
      // render immediately with empty array
      successCallback([]);

      // fetch month asynchronously and update calendar once loaded
      fetchMonthEvents(info.start.getFullYear(), info.start.getMonth())
        .then(events => {
          calendar.addEventSource(events);
        });
    }
  });

  calendar.render();
});
</script>
