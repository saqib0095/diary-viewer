<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>

<div id='calendar-container' style="font-family: sans-serif; background: white; padding: 15px; border-radius: 8px;">
  <div id='status' style="text-align:center; padding: 10px; font-weight: bold;">Loading Team Leave...</div>
  <div id='calendar'></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
  const calendarEl = document.getElementById('calendar');
  const statusEl = document.getElementById('status');

  // Automatically get current month dates
  const now = new Date();
  const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];

  try {
    const response = await fetch(`https://timetastic-proxy.onrender.com/diary?from=${firstDay}&to=${lastDay}`);
    const data = await response.json();

    // SAFETY CHECK: Fixes the "forEach is not a function" error
    if (!Array.isArray(data)) {
      statusEl.innerHTML = `<span style="color:red;">Error: Proxy returned an object instead of a list.</span>`;
      console.log("Server Response:", data);
      return;
    }

    const calendarEvents = [];

    // Correctly nested loops to find the data
    data.forEach(day => {
      if (day.absences && Array.isArray(day.absences)) {
        day.absences.forEach(abs => {
          // Skip holidays to keep the calendar focused on staff
          if (abs.absenceType === "PublicHoliday") return;

          calendarEvents.push({
            title: abs.userName, //
            start: day.date,    //
            allDay: true,
            backgroundColor: abs.absenceType === 'Sick' ? '#e74c3c' : '#3498db',
            borderColor: 'transparent'
          });
        });
      }
    });

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      height: 'auto',
      events: calendarEvents,
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,listMonth'
      }
    });

    statusEl.style.display = 'none';
    calendar.render();

  } catch (err) {
    statusEl.innerHTML = `<span style="color:red;">Failed to connect to proxy.</span>`;
    console.error(err);
  }
});
</script>

<style>
  .fc-event-title { font-weight: 600; padding: 2px; }
  .fc-daygrid-event { border-radius: 4px; margin: 1px 2px; }
</style>
