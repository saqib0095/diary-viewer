<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>

<div id='calendar-container' style="font-family: sans-serif; background: white; padding: 15px;">
  <div id='debug-log' style="color: red; padding: 10px;"></div>
<div id='calendar-container' style="font-family: sans-serif; background: white; padding: 15px; border-radius: 8px;">
  <div id='status' style="text-align:center; color: #666; margin-bottom: 10px;">Checking Timetastic...</div>
  <div id='calendar'></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const debugEl = document.getElementById('debug-log');
  const statusEl = document.getElementById('status');

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
@@ -18,38 +18,56 @@
      center: 'title',
      right: 'dayGridMonth,listMonth'
    },
    // This function runs every time the month changes
    events: async function(info, successCallback, failureCallback) {
      statusEl.innerHTML = "Syncing data...";
      
      const start = info.startStr.split('T')[0];
      const end = info.endStr.split('T')[0];

      try {
        const response = await fetch(`https://timetastic-proxy.onrender.com/diary?from=${start}&to=${end}`);
        const data = await response.json();
        
        // Ensure the response isn't empty before parsing
        const text = await response.text();
        if (!text || text.trim() === "") {
          throw new Error("No data returned for this period.");
        }

        const data = JSON.parse(text);

        // Check if data is actually an array
        if (!Array.isArray(data)) {
          debugEl.innerHTML = "<strong>Proxy Error:</strong> " + JSON.stringify(data);
          console.error("Data is not an array:", data);
          statusEl.innerHTML = "Data Format Error.";
          return successCallback([]);
        }

        debugEl.innerHTML = ""; // Clear errors if it works
        const events = [];
        
        // Loop through the dates
        data.forEach(day => {
          if (day.absences) {
          // Loop through the absences for that date
          if (day.absences && Array.isArray(day.absences)) {
            day.absences.forEach(abs => {
              // Filters: Skip holidays/anniversaries to show only leave
              if (abs.absenceType === "PublicHoliday") return;

              events.push({
                title: abs.userName, //
                start: day.date,    //
                allDay: true
                allDay: true,
                backgroundColor: abs.absenceType === 'Sick' ? '#e74c3c' : '#3498db',
                borderColor: 'transparent'
              });
            });
          }
        });

        statusEl.innerHTML = ""; // Success
        successCallback(events);

      } catch (error) {
        debugEl.innerHTML = "<strong>Network Error:</strong> " + error.message;
        console.error("Fetch error:", error);
        statusEl.innerHTML = "Connection error. Retrying...";
        failureCallback(error);
      }
    }
@@ -58,3 +76,9 @@
  calendar.render();
});
</script>

<style>
  #calendar-container { box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 1px solid #ddd; }
  .fc-event { padding: 2px 4px; font-weight: bold; cursor: default; }
  .fc-toolbar-title { font-size: 1.2em !important; }
</style>
