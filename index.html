<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const statusEl = document.getElementById('status');

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: "auto",
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,listMonth'
    },

    events: async function(info, successCallback, failureCallback) {
      statusEl.innerHTML = "Syncing data...";

      const format = d => d.toISOString().slice(0, 10);
      const start = format(info.start);
      const end = format(info.end);

      const url = `https://timetastic-proxy.onrender.com/diary?from=${start}&end=${end}`;
      console.log("Fetching:", url);

      try {
        const response = await fetch(url);

        if (!response.ok) {
          const text = await response.text();
          console.error("Server response:", text);
          throw new Error("HTTP error: " + response.status);
        }

        const data = await response.json();

        const events = [];

        data.forEach(day => {
          if (!day.absences) return;

          day.absences.forEach(abs => {
            if (abs.absenceType === "PublicHoliday") return;

            events.push({
              title: abs.userName,
              start: day.date,
              allDay: true
            });
          });
        });

        statusEl.innerHTML = "";
        successCallback(events);

      } catch (error) {
        console.error("Fetch failed:", error);
        statusEl.innerHTML = "Connection error";
        failureCallback(error);
      }
    } // closes events
  }); // closes calendar config

  calendar.render();
});
</script>
