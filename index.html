<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' /> 
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script> 

<div id='calendar-container' style="font-family: sans-serif; background: white; padding: 15px; border-radius: 8px;"> 
  <div id='status' style="text-align:center; color: #666; margin-bottom: 10px;">Checking Timetastic...</div> 
  <div id='calendar'></div> 
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const statusEl = document.getElementById('status');

  const cache = {}; // store month events
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  // fetch one month asynchronously
  const fetchMonthEvents = async (year, month) => {
    const monthKey = `${year}-${String(month+1).padStart(2,'0')}`;
    if (cache[monthKey]) return cache[monthKey];

    statusEl.innerHTML = `Fetching ${monthKey}...`;

    const format = d => {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    };

    const monthStart = new Date(year, month, 1);
    const monthEnd = new Date(year, month+1, 0);
    const startStr = format(monthStart) + "T00:00:00";
    const endStr = format(monthEnd) + "T23:59:59";

    let retries = 0;
    while(retries < 5){
      try {
        const url = `https://timetastic-proxy.onrender.com/diary?from=${startStr}&to=${endStr}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(res.statusText);
        const data = await res.json();
        
        const events = [];
        data.forEach(day => {
          if(!day.absences) return;
          day.absences.forEach(abs => {
            if(abs.absenceType === "PublicHoliday") return;
            events.push({ title: abs.userName, start: day.date, allDay: true });
          });
        });

        cache[monthKey] = events;
        statusEl.innerHTML = "";
        return events;

      } catch(e) {
        retries++;
        console.warn(`Retry ${retries}:`, e);
        await sleep(1000);
      }
    }

    statusEl.innerHTML = "Failed to fetch month";
    return [];
  };

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: "auto",
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,listMonth'
    },

    events: function(info, successCallback) {
      // show calendar immediately with empty events
      successCallback([]);

      // load events asynchronously for the month
      fetchMonthEvents(info.start.getFullYear(), info.start.getMonth())
        .then(events => {
          calendar.addEventSource(events); // add events when ready
        });
    }
  });

  calendar.render();
});
</script>
