<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>

<div id='calendar-wrapper' style="font-family: Arial, sans-serif;">
  <div id='loading' style="text-align:center; padding: 20px;">Fetching Team Schedule...</div>
  <div id='calendar'></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
  const calendarEl = document.getElementById('calendar');
  const loadingEl = document.getElementById('loading');

  // 1. Auto-calculate current month range
  const now = new Date();
  const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];

  try {
    // 2. Fetch the data from your proxy
    const response = await fetch(`https://timetastic-proxy.onrender.com/diary?from=${firstDay}&to=${lastDay}`);
    const data = await response.json();
    
    // 3. Map Timetastic data to Calendar Events
    const events = [];
    
    data.forEach(day => {
      // Each day object contains an 'absences' array
      if (day.absences && Array.isArray(day.absences)) {
        day.absences.forEach(abs => {
          // Optional: Hide Public Holidays to keep the calendar clean
          if (abs.absenceType === "PublicHoliday") return;

          events.push({
            title: abs.userName,    // Name from the absence record
            start: day.date,       // Date from the day record
            color: getEventColor(abs.absenceType),
            extendedProps: { type: abs.absenceType }
          });
        });
      }
    });

    // 4. Initialize and display the calendar
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      height: 650,
      events: events,
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,listMonth'
      }
    });

    loadingEl.style.display = 'none';
    calendar.render();

  } catch (error) {
    loadingEl.innerHTML = `<span style="color:red;">Error loading calendar: ${error.message}</span>`;
    console.error(error);
  }
});

// Simple helper to color-code different leave types
function getEventColor(type) {
  switch(type) {
    case 'Sick': return '#e74c3c'; // Red
    case 'Maternity': return '#9b59b6'; // Purple
    default: return '#3498db'; // Blue
  }
}
</script>

<style>
  #calendar-wrapper { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  .fc-header-toolbar { margin-bottom: 1.5em !important; }
  .fc-event { border: none !important; padding: 2px 5px; font-weight: bold; }
</style>
