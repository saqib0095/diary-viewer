<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>

<div id='calendar-container' style="font-family: sans-serif; background: white; padding: 15px; border-radius: 8px;">
  <div id='calendar'></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 650,
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,listMonth'
    },
    // This function runs every time you change the month
    events: async function(info, successCallback, failureCallback) {
      // Get the start and end dates of the current view (e.g., March 1st to March 31st)
      const start = info.startStr.split('T')[0];
      const end = info.endStr.split('T')[0];

      try {
        const response = await fetch(`https://timetastic-proxy.onrender.com/diary?from=${start}&to=${end}`);
        const data = await response.json();

        if (!Array.isArray(data)) {
          console.error("Data is not an array:", data);
          return successCallback([]);
        }

        const events = [];
        data.forEach(day => {
          if (day.absences && Array.isArray(day.absences)) {
            day.absences.forEach(abs => {
              // Filters
              if (abs.absenceType === "PublicHoliday") return;

              events.push({
                title: abs.userName, //
                start: day.date,    //
                allDay: true,
                backgroundColor: abs.absenceType === 'Sick' ? '#e74c3c' : '#3498db'
              });
            });
          }
        });
        
        successCallback(events);
      } catch (error) {
        console.error("Fetch error:", error);
        failureCallback(error);
      }
    }
  });

  calendar.render();
});
</script>
